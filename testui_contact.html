<!doctype html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>jQuery Mobile Panel - Hongkiat.com</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <link rel="stylesheet" href="css/themes/default/jquery.mobile-1.4.5.min.css">  
  <link href="smartphone/css/style.css" rel='stylesheet' type='text/css' />  
  <link rel="stylesheet" href="css/style.mobile.css" />
  <link rel="stylesheet" href="css/style.css">

  <link type="text/css" rel="stylesheet" href="smartphone/css/jquery.mmenu.all.css" /> 
  <link rel="stylesheet" href="css/app.css"> 
  <link href="css/jquery.mobile.iscrollview.css" media="screen" rel="stylesheet" type="text/css" />
  <script src="js/jquery.js"></script>
  <script src="js/jquery.mobile.js"></script>
  <!-- hans -->
  <script src="js/parse-1.2.13.min.js"></script>
      
  <script src="js/iscroll.js" type="text/javascript"></script>
  <script src="js/jquery.mobile.iscrollview.js" type="text/javascript"></script>
  <script type="text/javascript" charset="utf-8" src="js/phonegap.js"></script>
  <script type="text/javascript" src="cordova.js"></script>
  <script src="js/parse-1.2.13.min.js"></script>
     <script src="js/data_bin.js"></script> 
<!--   // <script src="js/index.js"></script> -->

  <body>
   <div class="demo-wrapper" data-role="page" id="page_addcontact">
     <div class="header"   data-role="header" > <span class="open left"><a href="#page_home">&#9664;</a></span> <span class="title" id="friend_title_label">Friend</span> <span class="open right"></div>
     <div class="content" data-role="content" data-iscroll class="iscroll-wrapper">

<!-- <div data-role="content" data-iscroll class="iscroll-wrapper"> -->
   <!--style='max-height:75%;position: absolute;' -->
 <div data-role="popup" id="popupBasicadd">
  <p>新增成功<p>
</div>
 <div data-role="collapsibleset" data-theme="a" data-content-theme="b">
    <div data-role="collapsible"  data-collapsed="false">
  <h2>聯絡簿</h2><ul data-role="listview"  id="list_phone_c">
    <div class="contact_add">
        <headx><img src="img/mkalalang_120.jpg" width="50px" height="50px" /></headx><h2> 關於我</h2><buttonx><img src="img/ic_friendlist_news.png" width="40px" height="40px" align="right" id="saaaaa" onclick="$('#saaaaa').remove();$('#popupBasicadd').popup('open');"/></buttonx>
    </div>
        <div class="contact_add">
        <headx><img src="img/mkalalang_120.jpg" width="50px" height="50px"/></headx><h2> 關於我</h2><buttonx><img src="img/ic_friendlist_news.png" width="40px" height="40px" align="right"/></buttonx>
    </div>
        <div class="contact_add">
        <headx><img src="img/mkalalang_120.jpg" width="50px" height="50px"/></headx><h2> 關於我</h2><buttonx><img src="img/ic_friendlist_news.png" width="40px" height="40px" align="right"/></buttonx>
    </div>
        <div class="contact_add">
        <headx><img src="img/mkalalang_120.jpg" width="50px" height="50px"/></headx><h2> 關於我</h2><buttonx><img src="img/ic_friendlist_news.png" width="40px" height="40px" align="right"/></buttonx>
    </div>
 </ul>
  </div>
    <div data-role="collapsible">
    <h2>推薦名單</h2>
        <ul data-role="listview" data-filter-theme="a" data-divider-theme="b">
        </ul>
    </div>

 </div>
</div>


</body>
<script>
user_list=[];
// // alert("aaa");
document.addEventListener("deviceready", onDeviceReady, false);
// Create Functions
function onDeviceReady() {
    // alert("Occured1");
   // $.mobile.loading("show");
$.mobile.loading( 'show', {
  text: '取得資料中.......',
  textVisible: true,
  theme: 'b',
  html: ""
});

  var options = new ContactFindOptions();
  options.filter="";
  options.multiple=true;
  var fields = ["*"];
  // $("#contactList").append("<li><h1>"+"Hans"+"</h1></li>");

  navigator.contacts.find(fields, onSuccess, onError, options);
  // alert("Some Error Occured2");
}
function onSuccess(contacts) {
  // alert(contacts.length);
  user_list=[];
 for (var i = 0; i < contacts.length; i++) {
    if(contacts[i].phoneNumbers!=null)
      {
        for (var j=0; j<contacts[i].phoneNumbers.length; j++) {
        if(contacts[i].phoneNumbers[j].type=="mobile")
          user_list[user_list.length]=fix_phone_number(contacts[i].phoneNumbers[j].value);
            // msg="<li><h1>"+contacts[i].displayName;           
            //                    msg=msg+"Type: " + contacts[i].phoneNumbers[j].type + "Value: "  + contacts[i].phoneNumbers[j].value;
            //             } 
            }
            // msg=msg+"</h1></li>";
    }                        
  }
      $("#list_phone_c").empty();
      getContactPhone();

}

function onError()
{
  alert("Some Error Occured");
}
  Parse.initialize("0MJW9p71s1OXaqG4tJdFx7s1vwujM6M9aHDZHhMk","W2QWiaW5BvN1mT6I7JSX0MLbV5ZnyjhhjfIsVPJt");
 Parse.User.logIn("886922273387", "qwerty", {
  success: function(user) {
    // alert("Some Error Occuredxxx");
    login_user=user;
     // user_list=[];
     // user_list[user_list.length]="886937047552";
     // user_list[user_list.length]="886952562018";
     // user_list[user_list.length]="886922273387";     
     // user_list[user_list.length]="886928897648";     
     // $("#list_phone_c").empty();
     // getContactPhone();
     // alert(user.id);
//     Parse.Cloud.run('updateParseInstallation', {"UserID":user.id,"InstallationID":"22cc7908-84a2-4d4b-abaa-7b3f0ca458e2" }, {
//       success: function(result) {
//         alert("Success");
//         // result is 'Hello world!'
//       },
//       error: function(error) {
//         alert(error.message);
//       }
// });
    // Parse.User.enableRevocableSession();
       // alert(Parse.User.Session);
  },
  error: function(user, error) {
    alert("error");
    // The login failed. Check error to see why.
  }
  });   
// alert(Parse.User.current());
// if( Parse.User.current())
// {

//      login_user=Parse.User.current();
//     $("#User_Name").text(login_user.get("displayName"));
//         // alert(JSON.stringify(Parse.User.current()));    
//        // alert(Parse.User.current().get("image").url());
//      document.getElementById("imageid").src=login_user.get("image").url();

//       update_friend_list();
// }
// else    
// {  
   // alert("ddsds");
 


// }        

function getContactPhone()
{
      var messagex = Parse.Object.extend("UserContact");           
      var query = new Parse.Query(messagex);
        // alert("asaa");
        query.equalTo("is_following",true); 
        query.find({
          success: function(results) {

            contacts=[];
            // results;
           // alert("Successfully retrieved " + results.length + " scores.");
          // Do something with the returned Parse.Object values
          for (var i = 0; i < results.length; i++) { 
           var object = results[i];           
           contacts[contacts.length]=object.get("phone");

            //alert(object.get("phone")); 
           } 
           // return contacts;
           contacts[contacts.length]=Parse.User.current().get("phone");
           // alert("Successfully retrievedx ssss" + contacts.length + " scores.");
           var result_list=getUniquePhoneList(user_list,contacts);
                   getAddUserList(result_list);
//           alert("Successfully retrievedx " + result_list.length + " scores.");
         },
         error: function(error) {
          alert("Error: " + error.code + " " + error.message);
          // return null;
        }
      });

}


function getUniquePhoneList(localPhones,Contacts_list)
{
    for(var i = Contacts_list.length-1;i>=0;i--){
      // alert(Contacts_list[i]);
        var ix = localPhones.indexOf(Contacts_list[i]);
        if(ix != -1) {
            localPhones.splice(ix, 1);
            // alert("splice "+Contacts_list[i]);
        }
    }
    return localPhones;

}

function getAddUserList(uniq_list)
{
      var messagex = Parse.Object.extend("User");           
      var query = new Parse.Query(messagex);
      query.containedIn("username",uniq_list);
         query.find({
          success: function(results) {
            contacts=results;
           // alert("Successfully retrieved " + results.length + " scores.");

           // alert(getContactPhone());
           
          // Do something with the returned Parse.Object values
          target_id=null;
          for (var i = 0; i < results.length; i++) { 
           var object = results[i];
                   var imguu=object.get("image");
                   var imgurl="img/ic_group.png";

                    // alert(object.get("care").get("image").url());
                    if(imguu==null)
                    {
                      // imgurl="";
                    }else
                    {
                      imgurl=object.get("image").url();
                    }
            msg=" <div class=\"contact_add\"><headx><img src=\""+ imgurl +"\" width=\"50px\" height=\"50px\"/></headx><h2>"+object.get("displayName")+"</h2><buttonx><img src=\"img/ic_friendlist_news.png\" width=\"40px\" height=\"40px\" align=\"right\" id=\""+object.id+"_img\" onclick=\"addUserCares('"+object.id+"','"+object.get("phone")+"')\"/></buttonx></div>";
                // alert(imgurl);
              $("#list_phone_c").append(msg);
            }
            $("#list_phone_c").listview("refresh");
            $.mobile.loading("hide");
          },
         error: function(error) {
          alert("Error: " + error.code + " " + error.message);
        }
      });

}

function addUserCares(care_user_id,care_user_phone)
{
  // alert(care_user_id);
             Parse.Cloud.run('addUserCares', {"CareID":care_user_id,"phone":care_user_phone }, {
                           success: function(result) {
//                           alert("Success reg");
                           // result is 'Hello world!'
                           // alert('新增成功');
                           $('#popupBasicadd').popup('open');
                           $('#'+care_user_id+'_img').remove();

                           },
                           error: function(error) {
                           alert(error.message);
                           }
                           });
                           
}

</script>